{% extends './../frame.html' %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <form action="/api/group/{{current_group}}/submissions/0/submit/">
            <input type="hidden" name="id" value="{{data['id']}}">
            <input type="hidden" name="token" value="{{account['token']}}">
            <h1><a href="/group/{{current_group}}/problems/{{data['id']}}/">{{data['id']}}.{{data['title']}}</a></h1>
            <div class="form-inline margin-bottom">
                <label class="control-label">Execute Type:</label>
                <select class="selectpicker" name="execute_type_id">
                    {% for x in data['execute'] %}
                        <option value="{{x['id']}}">{{map_lang[x['lang']]}}|{{x['description']}}</option>
                    {% end %}
				</select>
			</div>
			<div class="form-inline margin-bottom">
				<label class="control-label">
					從電腦上傳
				</label>
				<a class="btn btn-default btn-sm btn-file" onclick="$(this).parent().find('input').click();">
					檔案
				</a>
				<input name="code_file" class="input hidden" type="file" onchange="$(this).parent().find('a.btn-file').html($(this).val()!=''?$(this).val():'檔案');">
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="form-inline">
						<label class="control-label">File Name:</label>
						<input class="form-control" type="text" name="plain_file_name">
						<label class="control-label">Theme:</label>
						<select class="selectpicker" name="theme">
							<option>default</option>
							<option>3024-day</option>
							<option>3024-night</option>
							<option>abcdef</option>
							<option>ambiance</option>
							<option>base16-dark</option>
							<option>base16-light</option>
							<option>bespin</option>
							<option>blackboard</option>
							<option>cobalt</option>
							<option>colorforth</option>
							<option>dracula</option>
							<option>eclipse</option>
							<option>elegant</option>
							<option>erlang-dark</option>
							<option>hopscotch</option>
							<option>icecoder</option>
							<option>isotope</option>
							<option>lesser-dark</option>
							<option>liquibyte</option>
							<option>material</option>
							<option>mbo</option>
							<option>mdn-like</option>
							<option>midnight</option>
							<option>monokai</option>
							<option>neat</option>
							<option>neo</option>
							<option>night</option>
							<option>paraiso-dark</option>
							<option>paraiso-light</option>
							<option>pastel-on-dark</option>
							<option>railscasts</option>
							<option>rubyblue</option>
							<option>seti</option>
							<option>solarized dark</option>
							<option>solarized light</option>
							<option>the-matrix</option>
							<option>tomorrow-night-bright</option>
							<option>tomorrow-night-eighties</option>
							<option>ttcn</option>
							<option>twilight</option>
							<option>vibrant-ink</option>
							<option>xq-dark</option>
							<option>xq-light</option>
							<option>yeti</option>
							<option>zenburn</option>
						</select>
                    </div>
                </div>
                <div class="panel-body edit">
                    <textarea class="form-control" name="plain_code" rows=25></textarea>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Submit</button>
        </form>
    </div>
</div>
<script>
require(["jquery",'codemirror', "bootbox", "bootstrap-select"], function($, CodeMirror, bootbox){
	var support_lang = ['clike', 'python', 'perl', 'javascript', 'ruby', 'go', 'shell'];
	var map_lang_mode = Object();
	{% for x in data['execute'] %}
	map_lang_mode["{{x['id']}}"] = "{{x['cm_mode']}}";
	{% end %}
	var gen_support_lang_list = function(langs){
		var lang_list = Array();
		for(var lang in langs){
			lang = langs[lang];
			lang = 'codemirror/mode/' + lang + '/' + lang;
			lang_list.push(lang);
		}
		return lang_list;
	}
	require(gen_support_lang_list(support_lang).concat(['loadCSS', 'onloadCSS', 
			'codemirror/addon/edit/matchbrackets']), function(){
		console.log(CodeMirror.mimeModes);
		var codemirror = CodeMirror.fromTextArea($('[name=plain_code]')[0], {
			lineNumbers: true,
			mode: map_lang_mode[$('[name=execute_type_id]').val()],
			matchBrackets: true,
			theme: "default"
		});
		$('[name=execute_type_id]').change(function(){
			codemirror.setOption("mode", map_lang_mode[$(this).val()]);
		});
		$('[name=theme]').change(function(){
			var theme = $(this).val();
			onloadCSS(loadCSS('/asset/codemirror/theme/' + theme.split(' ')[0] + '.css'), function(){
				console.log(theme);
				codemirror.setOption("theme", theme);
			});
		});
	});
    $("button").prop("disabled", false);
    $(".selectpicker").selectpicker();
    $("form").submit(function(){
        var data = new FormData($(this)[0]);
        form = $(this);
        $("button").prop("disabled", true);
        $.ajax({
            url: form.attr("action"),
            type: "post",
            data: data,
            dataType: "json",
            processData: false,
            contentType: false,
            success: function(msg){
                $("button").prop("disabled", false);
                if(msg['status'] == 200){
                    location.href = "/group/{{current_group}}/submissions/"+msg['msg']+"/";
                } else {
                    bootbox.alert(msg['msg']);
                }
            }
        });
        return false;
    });
});
</script>
{% end %}
