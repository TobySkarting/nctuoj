{% extends './../frame.html' %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        <form action="/api/group/{{current_group}}/submissions/0/submit/">
            <input type="hidden" name="id" value="{{data['id']}}">
            <input type="hidden" name="token" value="{{account['token']}}">
            <h1><a href="/group/{{current_group}}/problems/{{data['id']}}/">{{data['id']}}.{{data['title']}}</a></h1>
            <div class="form-inline margin-bottom">
                {% set x = data['execute'][0] %}
                <input type="hidden" class="execute_type" name="execute_type_id" value="{{x['id']}}">
                <div class="row">
                    <div class="col-md-4">
                        <div class="dropdown" width="100%">
                            <span>Execute Type:</span>
                            <button class="btn btn-default dropdown-toggle execute_type" type="button" data-toggle="dropdown" style="min-width: 180px;">{{map_lang[x['lang']]}}|{{x['description']}}<span class="caret"></span></button>
                            <ul class="dropdown-menu" style="width: 100%">
                                {% for x in data['execute'] %}
                                    <li>
                                        <a onclick="change_lang(this);" data-id='{{x['id']}}' data-lang="{{x['lang']}}"data-maplang="{{map_lang[x['lang']]}}" data-description="{{x['description']}}">
                                            <div class="row">
                                                <div class="col-xs-4">{{map_lang[x['lang']]}}</div>
                                                <div class="col-xs-8">|{{x['description']}}</div>
                                            </div>
                                        </a>
                                    </li>
                                {% end %}
                            </ul>
                        </div>
                    </div>
                </div>
			</div>
			<div class="form-inline margin-bottom">
				<label class="control-label">
					從電腦上傳
				</label>
				<a class="btn btn-default btn-sm btn-file" onclick="$(this).parent().find('input').click();">
					檔案
				</a>
				<input name="code_file" class="input hidden" type="file" onchange="$(this).parent().find('a.btn-file').html($(this).val()!=''?$(this).val():'檔案');">
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="form-inline">
						<label class="control-label">File Name:</label>
						<input class="form-control" type="text" name="plain_file_name">
						<label class="control-label">Theme:</label>
						<select class="selectpicker" name="theme">
							<option>default</option>
							<option>3024-day</option>
							<option>3024-night</option>
							<option>abcdef</option>
							<option>ambiance</option>
							<option>base16-dark</option>
							<option>base16-light</option>
							<option>bespin</option>
							<option>blackboard</option>
							<option>cobalt</option>
							<option>colorforth</option>
							<option>dracula</option>
							<option>eclipse</option>
							<option>elegant</option>
							<option>erlang-dark</option>
							<option>hopscotch</option>
							<option>icecoder</option>
							<option>isotope</option>
							<option>lesser-dark</option>
							<option>liquibyte</option>
							<option>material</option>
							<option>mbo</option>
							<option>mdn-like</option>
							<option>midnight</option>
							<option>monokai</option>
							<option>neat</option>
							<option>neo</option>
							<option>night</option>
							<option>paraiso-dark</option>
							<option>paraiso-light</option>
							<option>pastel-on-dark</option>
							<option>railscasts</option>
							<option>rubyblue</option>
							<option>seti</option>
							<option>solarized dark</option>
							<option>solarized light</option>
							<option>the-matrix</option>
							<option>tomorrow-night-bright</option>
							<option>tomorrow-night-eighties</option>
							<option>ttcn</option>
							<option>twilight</option>
							<option>vibrant-ink</option>
							<option>xq-dark</option>
							<option>xq-light</option>
							<option>yeti</option>
							<option>zenburn</option>
						</select>
                        <label class="control-label">Editor Mode</label>
                        <select class="selectpicker" name="editor-mode">
                            <option>Normal</option>
                            <option>Vim</option>
                            <option>Sublime</option>
                            <option>Emacs</option>
                        </select>
                        <label class="control-label">F11 to fullscreen</label>
                    </div>
                </div>
                <div class="panel-body edit">
                    <textarea class="form-control" name="plain_code" rows=25></textarea>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Submit</button>
        </form>
    </div>
</div>
<script>
function change_lang(ele){
    require(["jquery"], function($){
        $("input.execute_type").val($(ele).attr("data-id"));
        $("button.execute_type").html($(ele).attr("data-maplang")+"|"+$(ele).attr("data-description"));
    });
}
require(["jquery",'codemirror', "bootbox", "bootstrap-select"], function($, CodeMirror, bootbox){
	var support_lang = ['clike', 'python', 'perl', 'javascript', 'ruby', 'go', 'shell'];
	var map_lang_mode = Object();
	{% for x in data['execute'] %}
	map_lang_mode["{{x['id']}}"] = "{{x['cm_mode']}}";
	{% end %}
	var gen_support_lang_list = function(langs){
		var lang_list = Array();
		for(var lang in langs){
			lang = langs[lang];
			lang = 'codemirror/mode/' + lang + '/' + lang;
			lang_list.push(lang);
		}
		return lang_list;
	}
    var keymap_js_list = ['codemirror/keymap/vim', 'codemirror/keymap/sublime', 'codemirror/keymap/emacs'];
	require(gen_support_lang_list(support_lang).
            concat(keymap_js_list).
            concat(['codemirror/addon/edit/matchbrackets', 
                'codemirror/addon/display/fullscreen',
                'codemirror/addon/dialog/dialog',
                'loadCSS', 'onloadCSS']), function(){
		console.log(CodeMirror.mimeModes);
		var codemirror = CodeMirror.fromTextArea($('[name=plain_code]')[0], {
			lineNumbers: true,
			mode: map_lang_mode[$('[name=execute_type_id]').val()],
			matchBrackets: true,
			theme: "default",
            tabSize: 4,
            indentUnit: 4,
            indentWithTabs: true,
            autofocus: true,
            extraKeys: {
                "F11": function(cm){
                    onloadCSS(loadCSS('/asset/codemirror/addon/display/fullscreen.css'), function(){
                        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                    });
                },
            },
		});
		$('[name=execute_type_id]').change(function(){
			codemirror.setOption("mode", map_lang_mode[$(this).val()]);
		});
		$('[name=theme]').change(function(){
			var theme = $(this).val();
			onloadCSS(loadCSS('/asset/codemirror/theme/' + theme.split(' ')[0] + '.css'), function(){
				codemirror.setOption("theme", theme);
			});
		});
        $('[name=editor-mode]').change(function(){
            var editor_mode = $(this).val().toLowerCase();
            onloadCSS(loadCSS('/asset/codemirror/addon/dialog/dialog.css'), function(){
                codemirror.setOption("keyMap", editor_mode);
            });
        });
	});
    $("button").prop("disabled", false);
    $(".selectpicker").selectpicker();
    $("form").submit(function(){
        var data = new FormData($(this)[0]);
        form = $(this);
        $("button").prop("disabled", true);
        $.ajax({
            url: form.attr("action"),
            type: "post",
            data: data,
            dataType: "json",
            processData: false,
            contentType: false,
            success: function(msg){
                $("button").prop("disabled", false);
                if(msg['status'] == 200){
                    location.href = "/group/{{current_group}}/submissions/"+msg['msg']+"/";
                } else {
                    bootbox.alert(msg['msg']);
                }
            }
        });
        return false;
    });
});
</script>
{% end %}
